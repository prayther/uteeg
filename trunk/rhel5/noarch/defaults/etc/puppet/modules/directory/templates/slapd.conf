#
# See slapd.conf(5) for details on configuration options.
# This file should NOT be world readable.
#
include		/etc/openldap/schema/core.schema
include		/etc/openldap/schema/cosine.schema
include		/etc/openldap/schema/inetorgperson.schema
include		/etc/openldap/schema/nis.schema
include		/etc/openldap/schema/dyngroup.schema

# This schema is the PEO-GES extentstion to the default schema's 
# provided by openldap  It defines two new object classes: extendedorgperson and extendedorggropu
# with DoD relevant attributes
include         /etc/openldap/schema/extendedinetorgperson.schema

#Include Policy File
include         /etc/openldap/schema/ppolicy.schema

# STIG requires idletimeout of 5 minutes
idletimeout 	300

# This logging is actually done via syslog and local4  
# To see configuraiton # see the /etc/syslog.conf file 
# Without configuring syslog, there will be no logs.
# Also, syslog and ldap need to be restarted for the changes to be applied.
# To see a definition of log levels, look here
# http://www.openldap.org/doc/admin24/slapdconfig.html
loglevel  <%=scope.lookupvar('directory::params::log_level')%> 

# Allow LDAPv2 client connections.  This is NOT the default.
# Why do we do this?
allow bind_v2

pidfile		/var/run/openldap/slapd.pid
argsfile	/var/run/openldap/slapd.args

# Load dynamic backend modules
modulepath	<%=scope.lookupvar('directory::params::module_path')%>

# This allow us to log access to a Berkely DB XML database
moduleload accesslog.la
# This overlay logs any modifications to a text (LDIF) file
moduleload auditlog.la
#  Allows password policies to be enforced
moduleload ppolicy.la
#  compiled module that implements SHA-256, SHA-384 and SHA-512 encryption
# This gets deployed by a custom RPM that includes the library
moduleload slapd-sha2.so


TLSCACertificateFile <%=scope.lookupvar('directory::params::truststore_fullpath')%> 
TLSCertificateFile <%=scope.lookupvar('directory::params::keystore_fullpath')%>
TLSCertificateKeyFile <%=scope.lookupvar('directory::params::keystore_fullpath')%>

# This is for the access log overlay
# The access log database has to appear before the directory backend database
database hdb
suffix "cn=accesslog"
rootdn "cn=accesslog"
rootpw	secret
directory /opt/openldap/ldap/accesslog_db
index default eq
index entryCSN,objectClass,reqEnd,reqResult,reqStart eq


#######################################################################
# ldbm and/or bdb database definitions
#######################################################################

database	<%= scope.lookupvar('directory::params::backend_db_type') %>
suffix		"<%= scope.lookupvar('directory::params::ldap_base')%>"
rootdn		"<%= scope.lookupvar('directory::params::root_dn')%>"
rootpw		<%= scope.lookupvar('directory::params::root_pw')%>

# The database directory MUST exist prior to running slapd AND 
# should only be accessible by the slapd and slap tools.
# Mode 700 recommended.
directory	<%= scope.lookupvar('directory::params::backend_db_path')%>

# Indices to maintain for this database
index objectClass                       eq,pres
index ou,cn,mail,surname,givenname      eq,pres,sub
index uidNumber,gidNumber,loginShell    eq,pres
index uid,memberUid                     eq,pres,sub
index nisMapName,nisMapEntry            eq,pres,sub

# These indexes are added to support Sync Repl replication
index entryCSN,entryUUID                eq

# This sectionconfigures access loggging using a LDAP database.
# Specify the database to be logged to, note that this databse
# has been defined above
overlay accesslog
logdb cn=accesslog
# What we want to log, this means 
# writes:  add, delete, modify, modrn
# reads: compare, search and only log successful operations
logops writes reads
logsuccess true
# Purge the log once a day and only maintain 90 days of logs
logpurge 90+00:00 01+00:00
# This means that when things are modified or deleted, the old and new changes are logged 
logold (objectclass=*)

limits dn.exact="cn=replication,O=U.S. Government,C=US" time.soft=unlimited time.hard=unlimited size.soft=unlimited size.hard=unlimited

overlay ppolicy
ppolicy_default "<%= scope.lookupvar('directory::params::ppolicy_default') %>"
ppolicy_use_lockout

# Audit logging
# This overlay logs all modifications to the directory to a LDIF file
# This same information is logged 
overlay auditlog
auditlog <%= scope.lookupvar('directory::params::audit_log_path') %>

# Access Definitions
access to <%= scope.lookupvar('directory::params::password_access_type') %> 
	by <%= scope.lookupvar('directory::params::password_access') %> <% "\n" %>
access to * 
<% scope.lookupvar('directory::params::specific_user_access').each do |access| -%>
	by  <%= access %>
<% end -%>

<% if master == true %> 
# Master Configuration for replication
<% scope.lookupvar('directory::params::master_repl_array').each do |m_repl_conf|-%><%= m_repl_conf %>
<% end -%>

<% end %>

<% if master == false %> 
# Slave Configuration for replication
# This looks through the array of repl configuration and adds to the file
<% scope.lookupvar('directory::params::slave_repl_array').each do |repl_conf|-%><%= repl_conf %>
<% end -%>

<% end %>

