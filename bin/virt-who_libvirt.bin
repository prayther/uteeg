#!/bin/bash -x

export PATH=$PATH:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
export HOME=/root

cd "${BASH_SOURCE%/*}"
source ../etc/install-configure-satellite.cfg
source ../etc/virt-inst.cfg
source ../etc/register_cdn.cfg
source ../etc/ak_create.cfg

#exec >> ../log/virt-who_libvirt.log 2>&1

# Install virt-who if it's not already
rpm -q virt-who || /usr/bin/yum install -y virt-who

cat << EOF > /etc/virt-who.d/${VMNAME}.${DOMAIN}.conf
[sat.laptop.prayther]
type=libvirt
#server=sat.laptop.prayther
server=${GATEWAY}
#username=root
#password=password
#encrypted_password=
owner=${ORG}
env=Library
hypervisor_id=hostname
EOF

# /etc/sysconfig/virt-who
grep -i "^VIRTWHO_SATELLITE6=1" /etc/sysconfig/virt-who || echo "VIRTWHO_SATELLITE6=1" >> /etc/sysconfig/virt-who

/usr/bin/systemctl enable virt-who
/usr/bin/systemctl start virt-who
#journalctl -u virt-who -f
exit 0

